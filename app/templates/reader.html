<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reader - Printing Press</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <a href="/" class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                Printing Press
            </a>
            <nav class="nav">
                <a href="/" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <span>Search</span>
                </a>
                <a href="/basket" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span>Basket</span>
                    <span class="badge" id="basket-count" style="display: none;">0</span>
                </a>
                <a href="/library" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>Library</span>
                </a>
                <a href="/events" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span>Events</span>
                    <span class="badge" id="unread-count" style="display: none;">0</span>
                </a>
            </nav>
        </header>

        <div class="reader-container">
            <div class="reader-toolbar">
                <a href="/library" class="btn btn-secondary btn-sm">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back
                </a>
                <div class="reader-title" id="reader-title">Loading...</div>
                <div class="reader-controls">
                    <button class="btn btn-secondary btn-sm" id="bookmark-btn" title="Toggle bookmark at current position">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <span id="bookmark-text">Bookmark</span>
                    </button>
                    <div class="view-toggle">
                        <button id="view-preview" class="active">Preview</button>
                        <button id="view-source">Source</button>
                    </div>
                </div>
            </div>
            
            <div class="reader-content preview-view" id="reader-content">
                <div class="loading"><div class="spinner"></div>Loading book...</div>
            </div>
        </div>
    </div>

    <div class="bookmark-indicator" id="bookmark-indicator">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>Bookmark saved</span>
    </div>

    <div class="toast-container" id="toast-container"></div>
    <script src="/static/js/app.js"></script>
    <script>
        const readerContent = document.getElementById('reader-content');
        const readerTitle = document.getElementById('reader-title');
        const viewPreview = document.getElementById('view-preview');
        const viewSource = document.getElementById('view-source');
        const bookmarkBtn = document.getElementById('bookmark-btn');
        const bookmarkText = document.getElementById('bookmark-text');
        const bookmarkIndicator = document.getElementById('bookmark-indicator');

        // Get book ID from URL
        const pathParts = window.location.pathname.split('/');
        const bookId = pathParts[pathParts.length - 1];

        let currentContent = '';
        let currentView = 'preview';
        let savedScrollPosition = null;
        let hasBookmark = false;

        async function loadBook() {
            try {
                const data = await api.getBook(bookId);
                readerTitle.textContent = data.title;
                document.title = `${data.title} - Printing Press`;
                currentContent = data.content;
                savedScrollPosition = data.scroll_position;
                hasBookmark = savedScrollPosition !== null && savedScrollPosition !== undefined;
                
                renderContent();
                updateBookmarkButton();
                
                // If we have a bookmark, scroll to it
                if (hasBookmark && savedScrollPosition > 0) {
                    setTimeout(() => {
                        readerContent.scrollTo({ top: savedScrollPosition, behavior: 'smooth' });
                    }, 100);
                }
            } catch (error) {
                readerContent.innerHTML = `
                    <div class="empty-state">
                        <h2>Error loading book</h2>
                        <p>${error.message}</p>
                        <a href="/library" class="btn btn-primary">Back to Library</a>
                    </div>`;
            }
        }

        function updateBookmarkButton() {
            if (hasBookmark) {
                bookmarkBtn.classList.add('bookmarked');
                bookmarkText.textContent = 'Bookmarked';
                bookmarkBtn.title = 'Click to go to bookmark, or long-press to remove';
            } else {
                bookmarkBtn.classList.remove('bookmarked');
                bookmarkText.textContent = 'Bookmark';
                bookmarkBtn.title = 'Save current position as bookmark';
            }
        }

        function renderContent() {
            if (currentView === 'preview') {
                readerContent.className = 'reader-content preview-view';
                readerContent.innerHTML = `<div class="markdown-body">${markdownToHtml(currentContent)}</div>`;
            } else {
                readerContent.className = 'reader-content source-view';
                readerContent.textContent = currentContent;
            }
        }

        function switchView(view) {
            currentView = view;
            viewPreview.classList.toggle('active', view === 'preview');
            viewSource.classList.toggle('active', view === 'source');
            renderContent();
        }

        async function savePosition() {
            const scrollPos = readerContent.scrollTop;
            try {
                await api.saveBookPosition(bookId, scrollPos);
                savedScrollPosition = scrollPos;
                hasBookmark = true;
                updateBookmarkButton();
                
                bookmarkIndicator.querySelector('span').textContent = 'Bookmark saved';
                bookmarkIndicator.classList.add('visible');
                setTimeout(() => bookmarkIndicator.classList.remove('visible'), 2000);
            } catch (error) {
                showToast('Failed to save position', 'error');
            }
        }

        async function removeBookmark() {
            try {
                await api.deleteBookmark(bookId);
                savedScrollPosition = null;
                hasBookmark = false;
                updateBookmarkButton();
                
                bookmarkIndicator.querySelector('span').textContent = 'Bookmark removed';
                bookmarkIndicator.classList.add('visible');
                setTimeout(() => bookmarkIndicator.classList.remove('visible'), 2000);
            } catch (error) {
                showToast('Failed to remove bookmark', 'error');
            }
        }

        function gotoBookmark() {
            if (savedScrollPosition !== null) {
                readerContent.scrollTo({ top: savedScrollPosition, behavior: 'smooth' });
            }
        }

        // Bookmark button handler - click to save/goto, long press to remove
        let longPressTimer = null;
        let longPressTriggered = false;
        
        bookmarkBtn.addEventListener('mousedown', () => {
            longPressTriggered = false;
            if (hasBookmark) {
                longPressTimer = setTimeout(() => {
                    longPressTriggered = true;
                    removeBookmark();
                    longPressTimer = null;
                }, 600);
            }
        });
        
        bookmarkBtn.addEventListener('mouseup', () => {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            if (!longPressTriggered) {
                if (hasBookmark) {
                    gotoBookmark();
                } else {
                    savePosition();
                }
            }
        });
        
        bookmarkBtn.addEventListener('mouseleave', () => {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });

        viewPreview.addEventListener('click', () => switchView('preview'));
        viewSource.addEventListener('click', () => switchView('source'));

        loadBook();
        updateBasketCount();
        updateUnreadCount();
    </script>
</body>
</html>
