<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Printing Press</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <a href="/" class="logo">üìö Printing Press</a>
            <nav class="nav">
                <a href="/" class="nav-link">Search</a>
                <a href="/basket" class="nav-link">
                    Basket
                    <span id="basket-badge" class="badge" style="display: none;">0</span>
                </a>
                <a href="/library" class="nav-link">Library</a>
                <a href="/events" class="nav-link active">
                    Events
                    <span id="events-badge" class="badge" style="display: none;">0</span>
                </a>
            </nav>
        </header>

        <main class="main">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h1>Events</h1>
                <button id="mark-all-read-btn" class="btn btn-secondary btn-sm" style="display: none;">
                    Mark All as Read
                </button>
            </div>

            <div id="events-container">
                <div class="loading"><div class="spinner"></div>Loading events...</div>
            </div>
        </main>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        const eventsContainer = document.getElementById('events-container');
        const markAllReadBtn = document.getElementById('mark-all-read-btn');

        async function loadEvents() {
            try {
                const data = await api('/events');

                if (data.events.length === 0) {
                    eventsContainer.innerHTML = `
                        <div class="empty-state">
                            <h2>üì¨ No Events Yet</h2>
                            <p>Your notifications will appear here when books finish processing.</p>
                        </div>
                    `;
                    markAllReadBtn.style.display = 'none';
                    return;
                }

                if (data.unread_count > 0) {
                    markAllReadBtn.style.display = 'block';
                } else {
                    markAllReadBtn.style.display = 'none';
                }

                let html = '<div class="card"><div class="card-body" style="padding: 0;">';

                for (const event of data.events) {
                    const unreadClass = event.read ? '' : 'unread';
                    let iconClass = 'info';
                    let icon = '‚ÑπÔ∏è';

                    if (event.event_type === 'book_ready') {
                        iconClass = 'book-ready';
                        icon = '‚úÖ';
                    } else if (event.event_type === 'processing_failed') {
                        iconClass = 'processing-failed';
                        icon = '‚ùå';
                    }

                    html += `
                        <div class="event-item ${unreadClass}" data-id="${event.id}">
                            <div class="event-icon ${iconClass}">${icon}</div>
                            <div class="event-content">
                                <div class="event-title">${escapeHtml(event.title)}</div>
                                <div class="event-message">${escapeHtml(event.message)}</div>
                                <div class="event-time">${formatRelativeTime(event.created_at)}</div>
                            </div>
                            ${event.book_id && event.event_type === 'book_ready' ? `
                                <a href="/read/${event.book_id}" class="btn btn-primary btn-sm">Read</a>
                            ` : ''}
                            ${!event.read ? `
                                <button class="btn btn-secondary btn-sm mark-read-btn" data-id="${event.id}">
                                    Mark Read
                                </button>
                            ` : ''}
                        </div>
                    `;
                }

                html += '</div></div>';
                eventsContainer.innerHTML = html;

                // Add mark read button listeners
                document.querySelectorAll('.mark-read-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const eventId = e.target.dataset.id;
                        await markEventRead(eventId);
                    });
                });

            } catch (e) {
                eventsContainer.innerHTML = `
                    <div class="empty-state">
                        <h2>Error</h2>
                        <p>${escapeHtml(e.message)}</p>
                    </div>
                `;
            }
        }

        async function markEventRead(eventId) {
            try {
                await api(`/events/${eventId}/read`, { method: 'POST' });
                loadEvents();
                updateUnreadCount();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function markAllRead() {
            try {
                await api('/events/read-all', { method: 'POST' });
                showToast('All events marked as read', 'success');
                loadEvents();
                updateUnreadCount();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        markAllReadBtn.addEventListener('click', markAllRead);

        // Initial load
        loadEvents();

        // Poll for updates
        setInterval(loadEvents, 10000);
    </script>
</body>
</html>
