<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library - Printing Press</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <a href="/" class="logo">üìö Printing Press</a>
            <nav class="nav">
                <a href="/" class="nav-link">Search</a>
                <a href="/basket" class="nav-link">
                    Basket
                    <span id="basket-badge" class="badge" style="display: none;">0</span>
                </a>
                <a href="/library" class="nav-link active">Library</a>
                <a href="/events" class="nav-link">
                    Events
                    <span id="events-badge" class="badge" style="display: none;">0</span>
                </a>
            </nav>
        </header>

        <main class="main">
            <h1 style="margin-bottom: 1.5rem;">Your Library</h1>

            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Search your library...">
                <button id="search-btn" class="btn btn-primary">Search</button>
                <button id="show-all-btn" class="btn btn-secondary">Show All</button>
            </div>

            <div id="library-container">
                <div class="loading"><div class="spinner"></div>Loading library...</div>
            </div>
        </main>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        const libraryContainer = document.getElementById('library-container');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const showAllBtn = document.getElementById('show-all-btn');

        async function loadLibrary() {
            try {
                const data = await api('/library');

                if (data.entries.length === 0) {
                    libraryContainer.innerHTML = `
                        <div class="empty-state">
                            <h2>üìñ Your Library is Empty</h2>
                            <p>Search for books and add them to start building your collection.</p>
                            <a href="/" class="btn btn-primary" style="margin-top: 1rem;">Search Books</a>
                        </div>
                    `;
                    return;
                }

                renderBooks(data.entries);
            } catch (e) {
                libraryContainer.innerHTML = `
                    <div class="empty-state">
                        <h2>Error</h2>
                        <p>${escapeHtml(e.message)}</p>
                    </div>
                `;
            }
        }

        async function searchLibrary(query) {
            if (!query.trim()) {
                loadLibrary();
                return;
            }

            libraryContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';

            try {
                const data = await api(`/library/search?q=${encodeURIComponent(query)}`);

                if (data.results.length === 0) {
                    libraryContainer.innerHTML = `
                        <div class="empty-state">
                            <h2>No Results Found</h2>
                            <p>No books in your library match "${escapeHtml(query)}".</p>
                        </div>
                    `;
                    return;
                }

                let html = `<p style="margin-bottom: 1rem; color: var(--text-muted);">Found ${data.count} result(s) for "${escapeHtml(query)}"</p>`;
                html += '<div class="book-list">';

                for (const result of data.results) {
                    const entry = result.entry;
                    const authors = entry.authors.length > 0 ? entry.authors.join(', ') : 'Unknown Author';
                    const score = (result.score * 100).toFixed(0);

                    html += `
                        <div class="book-item">
                            <div class="book-info">
                                <div class="book-title">
                                    <a href="/read/${entry.id}">${escapeHtml(entry.title)}</a>
                                </div>
                                <div class="book-author">${escapeHtml(authors)}</div>
                                <div class="book-meta">
                                    <span>üìä Relevance: ${score}%</span>
                                    <span>üìù ${entry.word_count.toLocaleString()} words</span>
                                    <span>üìÖ Added ${formatRelativeTime(entry.added_at)}</span>
                                </div>
                            </div>
                            <div class="book-actions">
                                        <a href="/read/${entry.id}" class="btn btn-primary btn-sm">Read</a>
                                        <button class="btn btn-danger btn-sm delete-book-btn" data-id="${entry.id}">Delete</button>
                                    </div>
                        </div>
                    `;
                }
                html += '</div>';
                libraryContainer.innerHTML = html;

            } catch (e) {
                libraryContainer.innerHTML = `
                    <div class="empty-state">
                        <h2>Error</h2>
                        <p>${escapeHtml(e.message)}</p>
                    </div>
                `;
            }
            // Attach delete handlers
            document.querySelectorAll('.delete-book-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const bookId = e.target.dataset.id;
                    if (!confirm('Permanently delete this book from your library?')) return;
                    try {
                        const res = await api(`/library/book/${bookId}`, { method: 'DELETE' });
                        if (res.success) {
                            showToast('Book deleted', 'success');
                            loadLibrary();
                        } else {
                            showToast(res.message || 'Failed to delete', 'error');
                        }
                    } catch (err) {
                        showToast(err.message, 'error');
                    }
                });
            });
        }

        function renderBooks(entries) {
            let html = `<p style="margin-bottom: 1rem; color: var(--text-muted);">${entries.length} book(s) in your library</p>`;
            html += '<div class="book-list">';

            for (const entry of entries) {
                const authors = entry.authors.length > 0 ? entry.authors.join(', ') : 'Unknown Author';

                html += `
                    <div class="book-item">
                        <div class="book-info">
                            <div class="book-title">
                                <a href="/read/${entry.id}">${escapeHtml(entry.title)}</a>
                            </div>
                            <div class="book-author">${escapeHtml(authors)}</div>
                            <div class="book-meta">
                                <span>üìù ${entry.word_count.toLocaleString()} words</span>
                                <span>üåê ${entry.languages.join(', ').toUpperCase()}</span>
                                <span>üìÖ Added ${formatRelativeTime(entry.added_at)}</span>
                            </div>
                        </div>
                        <div class="book-actions">
                            <a href="/read/${entry.id}" class="btn btn-primary btn-sm">Read</a>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            libraryContainer.innerHTML = html;
        }

        // Event listeners
        searchBtn.addEventListener('click', () => searchLibrary(searchInput.value));
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchLibrary(searchInput.value);
        });
        showAllBtn.addEventListener('click', () => {
            searchInput.value = '';
            loadLibrary();
        });

        // Initial load
        loadLibrary();
    </script>
</body>
</html>
